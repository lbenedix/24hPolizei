<!DOCTYPE html>
<html>
<head>
    <title>#24hPolizei @lbenedix</title>
    <meta charset="utf-8" />


    <link rel="stylesheet" href="css/kube.min.css" />
    <style type="text/css">
            /* CSS Mini Reset http://www.vcarrer.com/2010/05/css-mini-reset.html */
            html, body, div, form, fieldset, legend, label{margin: 0;padding: 0; }
            html{overflow-y: scroll;}
            table{border-collapse: collapse;border-spacing: 0;}
            th, td{text-align: left;vertical-align: top;}
            h1, h2, h3, h4, h5, h6, th, td, caption { font-weight:normal; }
            img { border: 0; }

            body{ padding:1em; }
            #karte{text-align: right; width:60%;position: fixed; top:100px;}
            #tweets .listWrapper{ overflow-y:auto; height:100%; width:100%; padding-right: 1em; }
            #tweets > div > ul > li { border: 1px solid #333; margin-top: 0.5em; padding: 0.5em; border-radius: 0.3em;list-style-type: none;}
            a { text-decoration: none; }
            svg{width: 100%; position: relative; top: -140px; left: 0px;}
            #socialshareprivacy > ul > li.settings_info.down{display:none;}
            polygon{fill:transparent;cursor:pointer;}


    </style>

</head>
<body>

    <div class="units-row" style="float:right;">
        <p class="input-groups unit-push-right width-25" >
            <input id="search_input" type="text" name="go" placeholder="Search" />
                            <span class="btn-append">
                                <button id="search_btn" class="btn btn-blue" style="width: 11em;">Alle durchsuchen</button>
                            </span>
        </p>
    </div>

    <div class="units-row">
        <div class="unit-60">
            <div class="units-row">
                <div>&nbsp;</div>
                <div id="karte">
                    <h2>&nbsp;</h2>
                    <span></span>
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 790" xml:space="preserve"></svg>
                </div>
            </div>
        </div>

        <div class="unit-40">
            <div class="units-row" id="tweets">
                <h3 id="info">
                    Klicke auf einen Bezirk, um die entsprechenden Tweets aus der <a href="https://twitter.com/hashtag/24hPolizei">#24hPolizei</a> Aktion zu sehen, oder durchsuche alle Tweets nach einem Stichwort.
                </h3>
                <div class="listWrapper">
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="units-row" style="position:fixed;bottom:-42px;right:0px;padding-right:142px;background: white;">
                <div id="socialshareprivacy"></div>
                <div style="position:fixed; bottom:10px; right:10px;">
                    <a href="mailto:lb@bombenlabor.de"><img src="lb.png" /></a>
                </div>

            </div>

        </div>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>

    <script type="text/javascript" src="js/jquery.socialshareprivacy.min.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(function($){
            if($('#socialshareprivacy').length > 0){
                $('#socialshareprivacy').socialSharePrivacy({
                                                                services : {
                                                                    facebook : {
                                                                        'status' : 'on'
                                                                    }
                                                                },
                                                                "alignment": "horizontal",
                                                                "switch_alignment":"right",
                                                                "css_path"  : "css/socialshareprivacy.css",
                                                                "lang_path" : "socialshareprivacy/lang/",
                                                                "language"  : "de",
                                                                'cookie_domain' : 'lb.bomenlabor.de'
                                                            });
            }
        });
    </script>


    <script>
        Number.prototype.map = function ( in_min , in_max , out_min , out_max ) {
            return ( this - in_min ) * ( out_max - out_min ) / ( in_max - in_min ) + out_min;
        }

        String.prototype.contains = function(it) { return this.indexOf(it) != -1; };

        String.prototype.endsWith = function(suffix) { return this.indexOf(suffix, this.length - suffix.length) !== -1; };


        var tweets = [];
        var bezirke_mapping = {'CharlottenburgNord':'Charlottenburg Nord', 'Spandau':'Spandau', 'StadtrandsiedlungMalchow':'Stadtrandsiedlung Malchow', 'Altglienicke':'Altglienicke', 'Adlershof':'Adlershof', 'Dahlem':'Dahlem', 'Tiergarten':'Tiergarten', 'FalkenhagenerFeld':'Falkenhagener Feld', 'Wilhelmstadt':'Wilhelmstadt', 'Rahnsdorf':'Rahnsdorf','Rahnsdorf1':'Rahnsdorf', 'Tegel':'Tegel', 'Rosenthal':'Rosenthal', 'Britz':'Britz', 'AltTreptow':'Alt-Treptow', 'Charlottenburg':'Charlottenburg', 'Heiligensee':'Heiligensee', 'Mitte':'Mitte', 'Kreuzberg':'Kreuzberg', 'Zehlendorf':'Zehlendorf', 'Steglitz':'Steglitz', 'Gesundbrunnen':'Gesundbrunnen', 'Wannsee':'Wannsee', 'Wannsee1':'Wannsee', 'Nikolassee':'Nikolassee', 'Luebars':'Lübars', 'Haselhorst':'Haselhorst', 'Koepenick':'Köpenick', 'Malchow':'Malchow', 'Baumschulenweg':'Baumschulenweg', 'Wedding':'Wedding', 'Gruenau':'Grünau', 'Blankenburg':'Blankenburg', 'Lichtenberg':'Lichtenberg', 'Siemensstadt':'Siemensstadt', 'Karlshorst':'Karlshorst', 'PrenzlauerBerg':'Prenzlauer Berg', 'Pankow':'Pankow', 'Bohnsdorf':'Bohnsdorf', 'Hermsdorf':'Hermsdorf', 'Lankwitz':'Lankwitz', 'Wartenberg':'Wartenberg', 'Schoeneberg':'Schöneberg', 'Hansaviertel':'Hansaviertel', 'Plaenterwald':'Plänterwalt', 'Neukoelln':'Neukölln', 'Wilmersdorf':'Wilmersdorf', 'Moabit':'Moabit', 'Staaken':'Staaken', 'Hakenfelde':'Hakenfelde', 'Rudow':'Rudow', 'Marienfelde':'Marienfelde', 'Wittenau':'Wittenau', 'Reinickendorf':'Reinickendorf', 'Schmargendorf':'Schmargendorf', 'Kladow':'Kladow', 'Grunewald':'Grunewald', 'Niederschoeneweide':'Niederschöneweide', 'Karow':'Karow', 'Friedrichshain':'Friedrichshain', 'FranzoesischBuchholz':'Französisch Buchholz', 'Frohnau':'Frohnau', 'Mueggelheim':'Müggelheim', 'Niederschoenhausen':'Niederschönhausen', 'Oberschoeneweide':'Oberschöneweide', 'Lichterfelde':'Lichterfelde', 'Mariendorf':'Mariendorf', 'Wilhelmsruh':'Wilhelmsruh', 'Konradshoehe':'Konradshöhe', 'Biesdorf':'Biesdorf', 'Rummelsburg':'Rummelsburg', 'Lichtenrade':'Lichtenrade', 'Westend':'Westend', 'Waidmannslust':'Waidmannslust', 'Halensee':'Halensee', 'Friedrichshagen':'Friedrichshagen', 'Buch':'Buch', 'MaerkischesViertel':'Märkisches Viertel', 'Falkenberg':'Falkenberg', 'Fennpfuhl':'Fennpfuhl', 'Gropiusstadt':'Gropiusstadt', 'Tempelhof':'Tempelhof', 'NeuHohenschoenhausen':'Neu Hohenschönhausen', 'Blankenfelde':'Blankenfelde', 'Johannisthal':'Johannisthal', 'Schmoeckwitz':'Schmöckwitz', 'Friedenau':'Friedenau', 'Heinersdorf':'Heinersdorf', 'Gatow':'Gatow', 'Mahlsdorf':'Mahlsdorf', 'Hellersdorf':'Hellersdorf', 'Kaulsdorf':'Kaulsdorf', 'Marzahn':'Marzahn', 'Friedrichsfelde':'Friedrichsfelde', 'AltHohenschoenhausen':'Alt Hohenschönhausen', 'Weissensee':'Weißensee', 'Buckow':'Buckow', 'Buckow1':'Buckow', 'Buckow_1':'Buckow'};

        var max_heat = 0;

        function get_heatmap( list_of_tweets ){
            var heat_map = {};
            /* initialize heat_map with zeros */
            $.each(bezirke_mapping, function(index, value){
                heat_map[index] = 0
            });

            max_heat = 0;
            $.each(list_of_tweets, function(index, tweet){
                if(tweet.bezirk  !== ""){
                    if(tweet.bezirk in heat_map){
                        heat_map[tweet.bezirk] += 1;
                        if( heat_map[tweet.bezirk] > max_heat ){
                            max_heat = heat_map[tweet.bezirk];
                        }
                    }
                }
            });

            /* map results to a scale from 0 to 0.9 for opacity */
            $.each(heat_map, function(index, heat){
                heat_map[index] = heat.map(0,max_heat,0,.9);
            });

            return heat_map;
        }

        function paint_map( list_of_tweets ){
            heat_map = get_heatmap(list_of_tweets);
            /* color the districts */
            $.each(bezirke_mapping, function(key, value){
                var bezirk = $('.'+key);
                bezirk.css( 'fill', '#E87B0C' );
                bezirk.css( 'fill-opacity', heat_map[key] )
                bezirk.css( 'stroke', '#003399' );
                bezirk.css( 'stroke-width', '.125' );
            });
        }

        function render_tweets( list_of_tweets ){
            $('#tweets ul').html('');
            $.each( list_of_tweets, function( key, tweet ) {
                $('#tweets ul').append(
                        '<li>'+
                        '<div>'+
                        '<div style="float: left;font-weight:bold;">'+bezirke_mapping[tweet.bezirk]+'</div>'+
                        '<span style="float: right;font-size:smaller"><a href="https://twitter.com/PolizeiBerlin_E/status/'+tweet['id']+'" target="_blank">'+moment(tweet['time'], 'YYYYMMDDHHmmss' ).format('HH:mm - DD.MM.YYYY')+'</a></span>' +
                        '</div>' +
                        '<div style="clear: both;">' + tweet['text'] + '</div>' +
                        '</li>'
                );
            });
            if( list_of_tweets.length == 1 ){
                $('#karte > span').text(list_of_tweets.length+' Einsatz');
            }else{
                $('#karte > span').text(list_of_tweets.length+' Einsätze');
            }

        }

        function search(query) {
            if(query.length==0){
                console.log('search, empty query');
                $('#info' ).show();
                $('#karte h2' ).html('&nbsp;');
                $('#karte > span' ).html('&nbsp;');
                $('#tweets ul').html('');
                window.location.hash = '';
                $.each(bezirke_mapping, function(bezirk_key, bezirk_value){
                    var bezirk = $('#'+bezirk_key);
                    bezirk.css( 'fill', '#E87B0C' );
                    bezirk.attr( 'fill-opacity', heatmap[bezirk_key] );
                });
            }else{
                var result_tweets = [];

                $('#info' ).hide();
                $('#karte h2' ).text(query);
                $('#karte > span' ).text('');
                $('#tweets ul').html('');
                window.location.hash = '';

                $.each( tweets, function( key, tweet ) {
                    if( tweet.text.toLowerCase().contains(query.toLowerCase()) ){

                        /* clone tweet*/
                        var tmp_tweet = {};
                        jQuery.extend(tmp_tweet,tweet);

                        /* highlight search terms */
                        var words = [];
                        var str = tweet.text.split(" ");
                        $(str).each(function(key, value){
                            if(value.toLowerCase().contains(query.toLowerCase())){
                                words.push('<mark>'+value+'</mark>');
                            }else{
                                words.push(value);
                            }
                        });
                        tmp_tweet.text = words.join(' ');
                        result_tweets.push(tmp_tweet);
                    }
                });

                paint_map(result_tweets);
                render_tweets(result_tweets);
            }
        };

        function filter_tweets_by_bezirk( bezirk ){
            var result_tweets = [];
            $.each( tweets, function( key, tweet ) {
                if(tweet.bezirk == bezirk ){
                    result_tweets.push(tweet);
                }
            });
            return result_tweets;
        }

        var initial_heatmap = get_heatmap( tweets );


        $( document ).ready(function() {

            $.get( "tweets.json", function( data ) {
                tweets = jQuery.parseJSON(data);
            });

                $('svg').load('Berliner_Bezirke.svg', function() {

                    /* add search function to inputbox and button */
                    $('#search_btn' ).click(function(){ search($('#search_input').val()); });
                    $("#search_input").keyup(function(event){ if(event.keyCode == 13){ $("#search_btn").click(); } });

                    paint_map(tweets);

                    $.each(bezirke_mapping, function(bezirk_key, bezirk_value){

                        var bezirk = $('#'+bezirk_key);

                        bezirk.hover(  function() {
                                           if(bezirk_key.endsWith('1')){ bezirk_key=bezirk_key.substring(0, bezirk_key.length - 1); }
                                           if(bezirk_key !== active_bezirk){
                                               $( '.'+bezirk_key ).css( 'stroke', 'blue' );
                                               $( '.'+bezirk_key ).css( 'stroke-width', '1' );
                                            }
                                       }, function() {
                                           if(bezirk_key.endsWith('1')){ bezirk_key=bezirk_key.substring(0, bezirk_key.length - 1); }
                                           if(bezirk_key !== active_bezirk){
                                               $( '.'+bezirk_key ).css( 'stroke', '#003399' );
                                               $( '.'+bezirk_key ).css( 'stroke-width', '.125' );
                                            }
                                         }
                        );
                        bezirk.click(function(){
                            /* hack for buckow, wannsee and rahnsdorf */
                            if(bezirk_key.endsWith('1')){ bezirk_key=bezirk_key.substring(0, bezirk_key.length - 1); }

                            $("html, body").animate({ scrollTop: 0 }, "fast");
                            $('#info' ).hide();
                            $('#search_input' ).val('');
                            active_bezirk = bezirk_key;
                            window.location.hash = bezirk_key;
                            $('#karte h2' ).text(bezirke_mapping[bezirk_key]);
                            var bezirk_tweets = filter_tweets_by_bezirk( bezirk_key );
                            paint_map(tweets);
                            render_tweets(bezirk_tweets);
                            $( '.'+bezirk_key ).css( 'fill','blue' );
                            $( '.'+bezirk_key ).css( 'stroke', 'blue' );
                            $( '.'+bezirk_key ).css( 'stroke-width', '1' );
                        });
                    });

                    /* get bezirk from url hash */
                    var active_bezirk = window.location.hash.replace("#", "");
                    /* click this bezirk */
                    if(active_bezirk.length>0){
                        $('#'+active_bezirk ).click();
                    }
                });
//            });
        });


        window.addEventListener("popstate", function(e) {
            if( window.location.hash.length > 0){
                $( window.location.hash ).click();
            }else{
                paint_map(tweets);
                if( $('#search_input' ).val().length == 0 ){
                    console.log('popstate');
                    $('#info' ).show();
                    $('#tweets ul').html('');
                    $('#karte h2' ).html('&nbsp;');
                    $('#karte > span' ).html('&nbsp;');
                }
            }
        });
    </script>

</body>
</html>
